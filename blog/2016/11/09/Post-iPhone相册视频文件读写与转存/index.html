
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>iPhone相册视频文件读写与转存 - 一泓清泉的Blog</title>
  <meta name="author" content="一泓清泉">

  
  <meta name="description" content="背景介绍 最近在做一个涉及图像视频的项目，简单说就是在手机上对相册、或者本地文件中的视频文件读取、解码成图像并展示。 走过的弯路 一般情况下，用AVAssetImageGenerator对相册视频解码，只需用相册视频url生成AVAsset对象，然后读取视频CMTime即可。 由于项目是多人开发， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ishun.github.io/MyBlog/blog/2016/11/09/Post-iPhone%E7%9B%B8%E5%86%8C%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E4%B8%8E%E8%BD%AC%E5%AD%98/">
  <link href="/MyBlog/favicon.png" rel="icon">
  <link href="/MyBlog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/MyBlog/atom.xml" rel="alternate" title="一泓清泉的Blog" type="application/atom+xml">
  <script src="/MyBlog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/MyBlog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/MyBlog/">一泓清泉的Blog</a></h1>
  
    <h2>努力吧，少年.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/MyBlog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="ishun.github.io/MyBlog">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/MyBlog/">Blog</a></li>
  <li><a href="/MyBlog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">iPhone相册视频文件读写与转存</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-09T23:21:35+08:00'><span class='date'>2016 年11 月9 日</span> <span class='time'>11:21 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>背景介绍</h2>

<p>   最近在做一个涉及图像视频的项目，简单说就是在手机上对相册、或者本地文件中的视频文件读取、解码成图像并展示。</p>

<h2>走过的弯路</h2>

<p>一般情况下，用<code>AVAssetImageGenerator</code>对相册视频解码，只需用相册视频url生成<code>AVAsset</code>对象，然后读取视频<code>CMTime</code>即可。</p>

<p>由于项目是多人开发，视频解码是封装在底层，业务层只能输入remote url或者file url，而相册视频文件并不属于file url，所以最先想到的办法就是能不能将相册文件写到APP沙盒里，读取沙盒中视频文件，这样就满足参数输入了，搜索stackoverflow，结果以下代码就产生了。</p>

<pre><code>ALAssetRepresentation *rep = [asset defaultRepresentation];
unsigned long repSize      = (unsigned long)rep.size;

Byte *buffer      = (Byte *)malloc(repSize);
NSUInteger length = [rep getBytes:buffer fromOffset:0 length:repSize error:nil];

NSData *myData = [NSData dataWithBytesNoCopy:buffer length:length freeWhenDone:YES];
</code></pre>

<p>刚开始发现文件length为0，进一步调试发现myData为nil，这是为啥呢？<code>asset</code>对象是非空的，然而其属性size为0，猜测是不是因为类似资源应该先被打开，然后再去访问其属性，尝试了以下代码</p>

<pre><code>ALAssetsLibrary *assetLibrary=[[ALAssetsLibrary alloc] init];
[assetLibrary assetForURL:assetURL resultBlock:^(ALAsset *asset) {

        NSString *docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) objectAtIndex:0];
        NSString *mp4FilePath = [NSString stringWithFormat:@"%@/demo.mp4", docDir];

        ALAssetRepresentation *rep = [asset defaultRepresentation];
        Byte *buffer = (Byte*)malloc((unsigned long)rep.size);
        NSUInteger buffered = [rep getBytes:buffer fromOffset:0.0 length:(NSUInteger)rep.size error:nil];

        NSData *data = [NSData dataWithBytesNoCopy:buffer length:buffered freeWhenDone:YES];
        [data writeToFile:mp4FilePath options:NSDataWritingAtomic error:nil];
        NSURL *newFilePath = [NSURL fileURLWithPath:mp4FilePath];
} failureBlock:^(NSError *error) {
}];
</code></pre>

<p>run后发现data的length非空了，在真机上运行了几次，都可以正常解码，然而遇到了另外两个问题：1、视频文件过大时，copy时间+解码时间过长  2、低端机上由于内存占用较大，极易crash</p>

<p>个人猜测上面两个问题产生的根本原因是由于引入了malloc，文件过大时，内存占用也较大，这种方式看起来也较蹩脚，不像正派武功。再次查询AVFoundation Guide后，发现有个API应该可以为我所有，达到目的。</p>

<h2>正确的姿势</h2>

<h3>读取相册视频并copy至本地目录</h3>

<p>调用AVFoundation的AVAssetExportSession可将视频导出至自定义目录</p>

<pre><code>AVAsset *asset = [[AVURLAsset alloc] initWithURL:videoPath options:nil];

NSString *docDir = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) objectAtIndex:0];
NSString *mp4FilePath = [NSString stringWithFormat:@"%@/demo.mp4", docDir];
[[NSFileManager defaultManager] removeItemAtURL:[NSURL fileURLWithPath:mp4FilePath] error:nil];

NSString *presetName = AVAssetExportPreset1280x720;
self.exportSession = [[AVAssetExportSession alloc] initWithAsset:asset
                                                      presetName:presetName];
self.exportSession.outputURL = [NSURL fileURLWithPath:mp4FilePath];
self.exportSession.outputFileType = AVFileTypeMPEG4;

[self.exportSession exportAsynchronouslyWithCompletionHandler:^(void){
    switch (weakSelf.exportSession.status) {
        case AVAssetExportSessionStatusCompleted:
            // DO YOUR WORK
            break;
        case AVAssetExportSessionStatusFailed:
            break;
        case AVAssetExportSessionStatusCancelled:
            break;
        default:
            break;
    }
}];
</code></pre>

<p>这样就解决了内存问题，在低端机型下也可以顺畅运行，看来这条道算是正派武功</p>

<h3>视频文件写入相册</h3>

<p>在项目中我们也用到了将视频文件写入相册的功能，在此贴一下代码片段，以供参考</p>

<pre><code>[_library writeVideoAtPathToSavedPhotosAlbum: outputFileURL
                             completionBlock:^(NSURL *assetURL, NSError *error) {

                                }];
</code></pre>

<h2>总结</h2>

<p>虽然最终解决了功能问题和性能问题，留给我的思考很多，首先如果项目代码架构设计的够好，就无需大费周折就研究相册视频文件转存的问题。再次有些情况下黑科技是好的，可以解决问题，但是可能并非完美的解决方案，比如上文中提到的性能问题，所以说日常项目中，尽量使用官方提供的API，这样稳定性才有保障。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">一泓清泉</span></span>

      




<time class='entry-date' datetime='2016-11-09T23:21:35+08:00'><span class='date'>2016 年11 月9 日</span> <span class='time'>11:21 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://ishun.github.io/MyBlog/blog/2016/11/09/Post-iPhone%E7%9B%B8%E5%86%8C%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E4%B8%8E%E8%BD%AC%E5%AD%98/" data-via="" data-counturl="http://ishun.github.io/MyBlog/blog/2016/11/09/Post-iPhone%E7%9B%B8%E5%86%8C%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E4%B8%8E%E8%BD%AC%E5%AD%98/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/MyBlog/blog/2016/05/07/Post-%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Octopress%E5%88%9B%E5%BB%BAGithub%20Pages%E5%8D%9A%E5%AE%A2/" title="Previous Post: 利用Octopress和Github搭建一个自己的博客">&laquo; 利用Octopress和Github搭建一个自己的博客</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/MyBlog/blog/2016/11/09/Post-iPhone%E7%9B%B8%E5%86%8C%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E4%B8%8E%E8%BD%AC%E5%AD%98/">iPhone相册视频文件读写与转存</a>
      </li>
    
      <li class="post">
        <a href="/MyBlog/blog/2016/05/07/Post-%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Octopress%E5%88%9B%E5%BB%BAGithub%20Pages%E5%8D%9A%E5%AE%A2/">利用Octopress和Github搭建一个自己的博客</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - 一泓清泉 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
